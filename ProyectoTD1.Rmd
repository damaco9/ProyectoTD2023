---
title: "ProyectoTD1"
author: "Daniel Macho Collado, Paula Rodriguez Lanzas, Lucía López López"
date: "2023-04-19"
output: html_document
---

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(plotly)
```

## Carpeta:

```{r}
carpeta <- 'data/1059xlxveei79_ECGf2/27_09_2022/14.42.29_III_ECGyEXTyRESTO/'
```

## Cabecera Fichero Analógico:

```{r}
fich <- paste0(carpeta, 'cabecera_FicheroAnalogico.dat')
read.filename <- file(fich,'rb')
cab_fich_anal <- readBin(read.filename, what = integer(),  n = 7, size = 1, signed = FALSE)

dia <- cab_fich_anal[1]
mes <- cab_fich_anal[2]
anyo <- cab_fich_anal[3]
hora <- cab_fich_anal[4]
min <- cab_fich_anal[5]
seg <- cab_fich_anal[6]
resolucion <- cab_fich_anal[7]

cab_fich_anal2 <- readBin(read.filename, what = integer(), n = 3, size = 2, signed = TRUE)

voltaje_max <- cab_fich_anal2[1]
voltaje_min <- cab_fich_anal2[2]
frecuencia <- cab_fich_anal2[3]

datos_cabecera_anal <- data.frame(dia, mes ,anyo, hora, min, seg, resolucion, voltaje_max, voltaje_min, frecuencia)
```

## Cabecera Fichero Digital:

```{r}
fich <- paste0(carpeta, 'cabecera_FicheroDigital.dat')
read.filename <- file(fich,'rb')
cab_fich_dig <- readBin(read.filename, what = integer(), n = 8, size = 1, signed = FALSE)

dia <- cab_fich_dig[1]
mes <- cab_fich_dig[2]
anyo <- cab_fich_dig[3]
hora <- cab_fich_dig[4]
min <- cab_fich_dig[5]
seg <- cab_fich_dig[6]
resolucion <- cab_fich_dig[7]
canales <- cab_fich_dig[8]

datos_cabecera_dig <- data.frame(dia, mes ,anyo, hora, min, seg, resolucion, canales)
```

## Fichero Digital:

```{r}
fich <- paste0(carpeta, 'ficheroDigital.dat')
read.filename <- file(fich,'rb')
tamanyo <- file.info(fich)$size

fich_dig <- readBin(read.filename, what = integer(), n = tamanyo, size = 1,signed = FALSE)

HR1 <- c()
HR2 <- c()
MHR <- c()
TOCO <- c()
SPO2 <- c()
VCP <- c()
Ps <- c()
Pd <- c()
Pm <- c()
tiempo <- c()

suma <- 0

tamanyo2 <- file.info(fich)$size/9

for (i in 1 : tamanyo2) {

  suma <- suma + 0.25
  tiempo[i] <- suma
}


for (i in seq(1, length(fich_dig), by = 9)) {
  HR1 <- c(HR1, fich_dig[i])
  HR2 <- c(HR2, fich_dig[i + 1])
  MHR <- c(MHR, fich_dig[i + 2])
  TOCO <- c(TOCO, fich_dig[i + 3])
  SPO2 <- c(SPO2, fich_dig[i + 4])
  VCP <- c(VCP, fich_dig[i + 5])
  Ps <- c(Ps, fich_dig[i + 6])
  Pd <- c(Pd, fich_dig[i + 7])
  Pm <- c(Pm, fich_dig[i + 8])
}

datos_fich_dig <- data.frame(HR1, HR2, MHR, TOCO, SPO2, VCP, Ps, Pd, Pm, tiempo)
```

## Gráfico Fichero Digital:

```{r}
#plot(MHR, type = 'l')
datos_fich_dig2 <- datos_fich_dig %>%
  pivot_longer(cols = -tiempo, names_to = 'nombres', values_to = 'valor')

datos_digitales300 <- subset(datos_fich_dig2, tiempo <= 300)

grafico1 <- ggplot(datos_fich_dig2, aes(x = tiempo, y = valor, color = nombres)) + 
  geom_line() +
  labs(x = 'Tiempo', y = 'Valor', color = 'Variable') +
  theme_bw() +
  facet_wrap(.~nombres, scales = "free") + 
  scale_x_continuous(limits = c(0, 300), breaks = seq(0, 300, 50))
  

grafico <- ggplotly(grafico1)%>%
  layout(plot_bgcolor = 'white', paper_bgcolor = 'white')
grafico
```

## Gráfico Fichero Analógico:

```{r}
fich <- paste0(carpeta, 'ficheroAnalogico.dat')
read.filename <- file(fich,'rb')
tamanyo <- file.info(fich)$size

fich_anal <- readBin(read.filename, what = integer(),  n = tamanyo/2, size = 2, signed = TRUE)

tiempo <- c()

suma <- 0

tamanyo2 <- file.info(fich)$size/2

for (i in 1 : tamanyo2) {

  suma <- suma + 0.001
  tiempo[i] <- suma
}

datos_fich_anal <- data.frame(fich_anal, tiempo)

#grafico2 <- plot(fich_anal[650000:700000], type = 'l')

grafico1 <- ggplot(datos_fich_anal, aes(x = tiempo, y = fich_anal)) + 
  geom_line(color = 'blue') +
  labs(x = 'Tiempo', y = 'Valor') +
  theme_bw() +
  scale_y_continuous(limits = c(-250, 1000), breaks = seq(-250, 1000, 250)) +
  scale_x_continuous(limits = c(690, 700), breaks = seq(690, 700, 2.5))

grafico <- ggplotly(grafico1)%>%
  layout(plot_bgcolor = 'white', paper_bgcolor = 'white')
grafico
```

## Preguntas:

\- Cuál es el valor con más latidos por minuto? Y el mínimo?

\- Cuál es el momento del día donde normalmente se está más tranquilo, los latidos por minutos? Y el que más?

\- Cuál es la frecuencia cardíaca basal del feto?

\- Cómo varían las diferentes variables en el tiempo?

\- Qué patrones o características destacables se pueden observar al comparar las diferentes variables entre si?

\- Encontramos algún valor anómalo (outlier) en nuestros datos?
