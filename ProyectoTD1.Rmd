---
title: "ProyectoTD1"
author: "Daniel Macho Collado, Paula Rodriguez Lanzas, Lucía López López, Gonzalo Sánchez Muñoz"
date: "2023-04-19"
output: html_document
---

```{r}
rm(list=ls())
library(dplyr)
library(ggplot2)
library(tidyr)
library(plotly)
```

## Carpeta:

```{r}
carpeta <- 'data/1059xlxveei79_ECGf2/27_09_2022/14.42.29_III_ECGyEXTyRESTO/'
```

## Cabecera Fichero Analógico:

```{r}
fich <- paste0(carpeta, 'cabecera_FicheroAnalogico.dat')
read.filename <- file(fich,'rb')
cab_fich_anal <- readBin(read.filename, what = integer(),  n = 7, size = 1, signed = FALSE)

dia <- cab_fich_anal[1]
mes <- cab_fich_anal[2]
anyo <- cab_fich_anal[3]
hora <- cab_fich_anal[4]
min <- cab_fich_anal[5]
seg <- cab_fich_anal[6]
resolucion <- cab_fich_anal[7]

cab_fich_anal2 <- readBin(read.filename, what = integer(), n = 3, size = 2, signed = TRUE)
close(read.filename)

voltaje_max <- cab_fich_anal2[1]
voltaje_min <- cab_fich_anal2[2]
frecuencia <- cab_fich_anal2[3]

datos_cabecera_anal <- data.frame(dia, mes ,anyo, hora, min, seg, resolucion, voltaje_max, voltaje_min, frecuencia)
```

## Cabecera Fichero Digital:

```{r}
fich <- paste0(carpeta, 'cabecera_FicheroDigital.dat')
read.filename <- file(fich,'rb')
cab_fich_dig <- readBin(read.filename, what = integer(), n = 8, size = 1, signed = FALSE)
close(read.filename)

dia <- cab_fich_dig[1]
mes <- cab_fich_dig[2]
anyo <- cab_fich_dig[3]
hora <- cab_fich_dig[4]
min <- cab_fich_dig[5]
seg <- cab_fich_dig[6]
resolucion <- cab_fich_dig[7]
canales <- cab_fich_dig[8]

datos_cabecera_dig <- data.frame(dia, mes ,anyo, hora, min, seg, resolucion, canales)
```

## Fichero Digital:

```{r}
fich <- paste0(carpeta, 'ficheroDigital.dat')
read.filename <- file(fich,'rb')
tamanyo <- file.info(fich)$size

fich_dig <- readBin(read.filename, what = integer(), n = tamanyo, size = 1,signed = FALSE)
close(read.filename)

HR1 <- c()
HR2 <- c()
MHR <- c()
TOCO <- c()
SPO2 <- c()
VCP <- c()
Ps <- c()
Pd <- c()
Pm <- c()
tiempo <- c()

suma <- 0

tamanyo2 <- file.info(fich)$size/9

for (i in 1 : tamanyo2) {

  suma <- suma + 0.25
  tiempo[i] <- suma
}


for (i in seq(1, length(fich_dig), by = 9)) {
  HR1 <- c(HR1, fich_dig[i])
  HR2 <- c(HR2, fich_dig[i + 1])
  MHR <- c(MHR, fich_dig[i + 2])
  TOCO <- c(TOCO, fich_dig[i + 3])
  SPO2 <- c(SPO2, fich_dig[i + 4])
  VCP <- c(VCP, fich_dig[i + 5])
  Ps <- c(Ps, fich_dig[i + 6])
  Pd <- c(Pd, fich_dig[i + 7])
  Pm <- c(Pm, fich_dig[i + 8])
}

datos_fich_dig <- data.frame(HR1, HR2, MHR, TOCO, SPO2, VCP, Ps, Pd, Pm, tiempo)
```

## Gráfico Fichero Digital:

```{r}
datos_fich_dig2 <- datos_fich_dig %>%
  pivot_longer(cols = -tiempo, names_to = 'nombres', values_to = 'valor')

datos_digitales300 <- subset(datos_fich_dig2, tiempo <= 300)

grafico1 <- ggplot(datos_fich_dig2, aes(x = tiempo, y = valor, color = nombres)) + 
  geom_line() +
  labs(title = 'Fichero Digital', x = 'Tiempo', y = 'Valor', color = 'Variable') +
  theme_bw() +
  facet_wrap(.~nombres, scales = "free") + 
  scale_x_continuous(limits = c(0, 300), breaks = seq(0, 300, 50))
  

grafico <- ggplotly(grafico1)%>%
  layout(plot_bgcolor = 'white', paper_bgcolor = 'white')
grafico
```
## Fichero Analógico:

```{r}
fich <- paste0(carpeta, 'ficheroAnalogico.dat')
read.filename <- file(fich,'rb')
tamanyo <- file.info(fich)$size

fich_anal <- readBin(read.filename, what = integer(),  n = tamanyo/2, size = 2, signed = TRUE)
close(read.filename)

tiempo <- c()

suma <- 0

tamanyo2 <- file.info(fich)$size/2
Freq_muestreo <- 1000

for (i in 1 : tamanyo2) {

  suma <- suma + 1/Freq_muestreo
  tiempo[i] <- suma
}

datos_fich_anal2 <- data.frame(fich_anal, tiempo)
```

## Gráfico Fichero Analógico:

```{r}
datos_anal_tiemp <- subset(datos_fich_anal2, tiempo > max(tiempo)-10)

grafico1 <- ggplot(datos_anal_tiemp, aes(x = tiempo, y = fich_anal)) + 
  geom_line(color = 'blue') +
  labs(title = 'Fichero Analógico', x = 'Tiempo', y = 'Valor') +
  theme_bw() +
  scale_y_continuous(limits = c(-250, 1000), breaks = seq(-250, 1000, 250))

grafico <- ggplotly(grafico1)%>%
  layout(plot_bgcolor = 'white', paper_bgcolor = 'white')
grafico
```

## ## Analisis Exploratorio Fichero Digital:

```{r}
#Hacemos una exploracion inical de los datos:
summary(datos_fich_dig)
head(datos_fich_dig)
tail(datos_fich_dig)

#Observamos si hay valores NA, NULL o INF:
apply(datos_fich_dig,2,function(x){any(is.na(x))})
apply(datos_fich_dig,2,function(x){any(is.null(x))})
apply(datos_fich_dig,2,function(x){any(is.infinite(x))})

# Regla 3 sigma
reglasigma <- function(x) { 
  m <- mean(x,na.rm = T)
  s <- sd(x,na.rm = T)
  out <- (x>(m+3*s)|x<(m-3*s))
}


# Identificador Hampel
reglahampel <- function(x) { 
  m <- median(x,na.rm = T)
  s <- madm(x,na.rm = T)
  out <- (x>(m+3*s)|x<(m-3*s))
}


# Regla boxplot
reglaboxplot <- function(x) { 
  q1 <- quantile(x, 1 / 4, na.rm = T)
  q2 <- quantile(x, 3 / 4, na.rm = T)
  i <- IQR(x, na.rm = T)
  out <- (x>(q2+1.5*i)|x<(q1-1.5*i))
}


# Percentiles
reglapercentil <- function(x){ 
  q1 <- quantile(x, 0.05, na.rm = T)
  q2 <- quantile(x, 0.95, na.rm = T)
  out <- (x>q2|x<q1)
}

metodos <- list(reglasigma=reglasigma,reglaboxplot=reglaboxplot,reglapercentil=reglapercentil)

#Aplicamos los metodos a las variables:
datos_fich_dig <- datos_fich_dig %>% select(c(HR1, HR2, MHR, TOCO)) %>% mutate(across(where(is.numeric), metodos))
head(datos_fich_dig)

#Comporbamos el número de outliers detectados por método:
datos_fich_dig %>% select(contains("regla")) %>% summarise(across(everything(), ~sum(.,na.rm = T
)))


# Valores etiquetados como outliers, ordenados de menor a mayor:
sort(datos_fich_dig$HR1[datos_fich_dig$HR1_reglasigma])
sort(datos_fich_dig$HR1[datos_fich_dig$HR1_reglaboxplot])
sort(datos_fich_dig$HR1[datos_fich_dig$HR1_reglapercentil])
```

## Analisis Exploratorio Fichero Analógico:

```{r}
#Hacemos una exploracion inical de los datos:
summary(datos_fich_anal2)
head(datos_fich_anal2)
tail(datos_fich_anal2)

#Observamos si hay valores NA, NULL o INF:
any(is.na(datos_anal_tiemp))
any(is.null(datos_anal_tiemp))
apply(datos_anal_tiemp,2,function(x){any(is.infinite(x))})

# Regla 3 sigma
reglasigma <- function(x) { 
  m <- mean(x,na.rm = T)
  s <- sd(x,na.rm = T)
  out <- (x>(m+3*s)|x<(m-3*s))
}


# Identificador Hampel
reglahampel <- function(x) { 
  m <- median(x,na.rm = T)
  s <- madm(x,na.rm = T)
  out <- (x>(m+3*s)|x<(m-3*s))
}


# Regla boxplot
reglaboxplot <- function(x) { 
  q1 <- quantile(x, 1 / 4, na.rm = T)
  q2 <- quantile(x, 3 / 4, na.rm = T)
  i <- IQR(x, na.rm = T)
  out <- (x>(q2+1.5*i)|x<(q1-1.5*i))
}


# Percentiles
reglapercentil <- function(x){ 
  q1 <- quantile(x, 0.05, na.rm = T)
  q2 <- quantile(x, 0.95, na.rm = T)
  out <- (x>q2|x<q1)
}

metodos <- list(reglasigma=reglasigma,reglaboxplot=reglaboxplot,reglapercentil=reglapercentil)

#Aplicamos los metodos a las variables:
datos_fich_dig <- datos_fich_dig %>% select(c(HR1, HR2, MHR, TOCO)) %>% mutate(across(where(is.numeric), metodos))
head(datos_fich_dig)

#Comporbamos el número de outliers detectados por método:
datos_fich_dig %>% select(contains("regla")) %>% summarise(across(everything(), ~sum(.,na.rm = T
)))


# Valores etiquetados como outliers, ordenados de menor a mayor:
sort(datos_fich_dig$HR1[datos_fich_dig$HR1_reglasigma])
sort(datos_fich_dig$HR1[datos_fich_dig$HR1_reglaboxplot])
sort(datos_fich_dig$HR1[datos_fich_dig$HR1_reglapercentil])
```

## Quitamos outliers Fichero Digital:

```{r}
outHR1 = which(datos_fich_dig$HR1 > mean(datos_fich_dig$HR1) + 3 * sd(datos_fich_dig$HR1) | 
        datos_fich_dig$HR1 < mean(datos_fich_dig$HR1) - 3 * sd(datos_fich_dig$HR1))
for (i in outHR1){
  datos_fich_dig$HR1[i] = mean(datos_fich_dig$HR1[i-1], datos_fich_dig$HR1[i+1])
}

outHR2 = which(datos_fich_dig$HR2 > mean(datos_fich_dig$HR2) + 2.5 * sd(datos_fich_dig$HR2) | 
        datos_fich_dig$HR2 < mean(datos_fich_dig$HR2) - 2.5 * sd(datos_fich_dig$HR2))
for (i in outHR2){
  datos_fich_dig$HR2[i] = mean(datos_fich_dig$HR2[i-1], datos_fich_dig$HR2[i+1])
}

outMHR = which(datos_fich_dig$MHR == 16)
for (i in outMHR){
  datos_fich_dig$MHR[i] = mean(datos_fich_dig$MHR[i-1], datos_fich_dig$MHR[i+1])
}


outTOCO = c()
for (l in 2:(length(datos_fich_dig$TOCO) - 1)){
  dat = datos_fich_dig$TOCO[l]
  ant = datos_fich_dig$TOCO[l - 1]
  pos = datos_fich_dig$TOCO[l + 1]
  if ((dat < (ant - 10)) | (dat > (ant + 10)) | (dat < (pos - 10)) | (dat > (pos + 10))){
    outTOCO <- c(outTOCO, l)
  }
}
for (i in outTOCO){
  datos_fich_dig$TOCO[i] = mean(datos_fich_dig$TOCO[i-1], datos_fich_dig$TOCO[i+1])
}
```


## Gráfico Fichero Digital sin outliers:

```{r}
datos_fich_dig2 <- datos_fich_dig %>%
  pivot_longer(cols = -tiempo, names_to = 'nombres', values_to = 'valor')

datos_digitales300 <- subset(datos_fich_dig2, tiempo <= 300)

grafico1 <- ggplot(datos_fich_dig2, aes(x = tiempo, y = valor, color = nombres)) + 
  geom_line() +
  labs(title = 'Fichero Digital', x = 'Tiempo', y = 'Valor', color = 'Variable') +
  theme_bw() +
  facet_wrap(.~nombres, scales = "free") + 
  scale_x_continuous(limits = c(0, 300), breaks = seq(0, 300, 50))
  

grafico <- ggplotly(grafico1)%>%
  layout(plot_bgcolor = 'white', paper_bgcolor = 'white')
grafico
```




## Preguntas:

\- Cuál es el valor con más latidos por minuto? Y el mínimo?

\- Cuál es el momento del día donde normalmente se está más tranquilo, los latidos por minutos? Y el que más?

\- Cuál es la frecuencia cardíaca basal del feto?

\- Cómo varían las diferentes variables en el tiempo?

\- Qué patrones o características destacables se pueden observar al comparar las diferentes variables entre si?

\- Encontramos algún valor anómalo (outlier) en nuestros datos?
